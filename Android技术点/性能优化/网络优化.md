### 网络优化的认识

网络优化的维度：多维

网络流量的消耗量：需要精确，整体均值掩盖单点问题

网络相关监控：全面，粗粒度监控不能帮我们发现、解决深层次问题

流量消耗：一段时间流量消耗的精准度量，网络类型，前后台

监控相关：用户流量消耗均值，异常率（消耗多，次数多）

完整链路全部监控（Request， Response），主动上报

网络请求质量：

  	用户体验：请求速度、成功率

  	监控相关：请求时长，业务成功率，失败率，Top失败接口

其他：公司成本：带宽，服务器数，cdn；耗电量



### 流量统计工具

**NetWork Profiler**:

 显示实时网络活动：发送、接收数据和连接数

需要主动启用

只支持HttpURLConnection和OkHttp网络库



#### 线上流量获取方案：

**TrafficStats**：

API8以上重启以来的流量数据统计

getUidRxBytes(int uid)指定Uid的接收流量

getTotalTxBytes()总发送流量

无法获取某个时间段内的流量消耗

**NetworkStatsManager**：

api23之后的流量统计

可以获取指定时间间隔内的流量信息

可以获取不同网络类型下的消耗

[使用参考](https://blog.csdn.net/ZhangQiang_0/article/details/78043042?utm_source=blogxgwz5)



### 流量优化

增加缓存：

OkHttp设置开启缓存模式，无网时使用缓存数据，post请求Okhttp不主动做缓存

增量更新：加上版本信息

数据压缩：body使用gzip压缩；请求头压缩，使用md5；图片压缩

发送频率和时机：合并请求，减少请求次数；性能日志上报，批量+特定场景上报；

图片处理：webp



### 质量指标

DNS相关：使用httpDNS，绕过运营商域名解析过程

Http版本：

1.0 TCP链接不复用

1.1 引入持久连接，但数据通讯按次序进行

2    多工，客户端、服务器双向实时通信



### 质量监控

接口请求耗时，成功率，错误码

图片加载的每一步耗时



### 网络容灾机制

备用服务器分流

多次失败后一定时间不请求，避免雪崩

CDN加速、提高贷款、动静资源分离（更新后清理缓存）

减少传输量，注意请求时机和频率

OkHttp的请求池



### 网络体系

**线下测试**

只抓单独的app

侧重点：请求有误、多余，网络切换、弱网、无网测试

**线上监控**

服务端监控： 请求耗时（区分地域，时间段，版本，机型）； 失败率（业务失败和请求失败）；Top失败接口、异常接口；

客户端监控：接口每一步信息(DNS, 连接，请求等)；请求次数、网络包大小，失败原因；图片监控

监控体系：服务防刷；客户端大文件预警，异常兜底策略；单点问题追查

























