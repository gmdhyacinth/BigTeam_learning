# 句柄

[TOC]


## 定义

> 在程序设计中，句柄（handle）是Windows操作系统用来标识被应用程序所创建或使用的对象的整数。其本质相当于带有引用计数的智能指针。当一个应用程序要引用其他系统（如数据库、操作系统）所管理的内存块或对象时，可以使用句柄。

## 句柄与指针


句柄与普通指针的区别在于，指针包含的是引用对象的内存地址，而句柄则是由系统所管理的引用标识，该标识可以被系统重新定位到一个内存地址上。这种间接访问对象的模式增强了系统对引用对象的控制。

通俗的说就是我们调用句柄就是调用句柄所提供的服务，即句柄已经把它能做的操作都设定好了，我们只能在句柄所提供的操作范围内进行操作，但是普通指针的操作却多种多样，不受限制。

## 句柄与安全性

客户获得句柄时，句柄不仅是资源的标识符，也被授予了对资源的特定访问权限。


## 句柄与操作系统

在上世纪80年代的操作系统（如Mac OS[1]和Windows）的内存管理中，句柄被广泛应用。Unix系统的文件描述符基本上也属于句柄。和其它桌面环境一样，Windows API大量使用句柄来标识系统中的对象，并创建操作系统与用户空间之间的通信渠道。例如，桌面上的一个窗体由一个HWND类型的句柄来标识。

如今，内存容量的增大和虚拟内存算法使得更简单的指针愈加受到青睐，而指向另一指针的那类句柄受到冷淡。尽管如此，许多操作系统仍然把指向私有对象的指针以及进程传递给客户端的内部数组下标称为句柄。

---

## 辅助理解


### 数字

句柄就是个数字，一般和当前系统下的整数的位数一样，比如32bit系统下就是4个字节。这个数字是一个对象的唯一标示，和对象一一对应。这个对象可以是一个块内存，一个资源，或者一个服务的context（如 socket，thread）等等。这个数字的来源可以有很多中，只要能保证和它代表的对象保持唯一对应就可以，比如可以用内存地址，也可以用句柄表的序号，或者干脆用一个自增ID，再或者用以上的值去异或一个常数。传统上操作系统内核和系统服务API都是 C 语言接口的，但是其内部设计理念上又是OO的，所以有对象概念却没有对应的语言语法支持。句柄的作用就是在 C 语言环境下代替 C++ 的对象指针来用的。创建句柄就是构造，销毁句柄就是析构，用句柄调用函数相当于传入this指针。如果有系统API是  C++ 接口的，那么就没有句柄了，而是某个接口指针，IXXXPtr之类的，比如Windows的com ptr。

### 把手

最早的windows开发书籍，handle是被翻译成“把手”的。虽然不好听，但是个人认为相当传神。

1.虽然你握住的只是把手，却能拉动整扇门，而且你根本不用在意那门长什么样子

2.一扇门如果有多个把手，被不同的人（进程）握住，门往哪儿走就不好说了



## 参考

https://zh.wikipedia.org/wiki/%E5%8F%A5%E6%9F%84

https://www.zhihu.com/question/27656256

